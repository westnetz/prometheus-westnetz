systemd:
  units:
    - name: gnupg-deployment-key.service
      contents: |
        [Unit]
        Description=Add deployment key to GPG keyring
        After=network-online.target
        Requires=network-online.target
        ConditionPathExists=/root/deployment-key.pgp

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        StandardInput=file:/root/deployment-key.pgp
        ExecStart=/usr/bin/gpg --import
        ExecStartPost=/usr/bin/rm /root/deployment-key.pgp
    - name: docker-compose.service
      contents: |
        [Unit]
        Description=Install Docker Compose
        After=docker.service network-online.target
        Requires=docker.service network-online.target
        ConditionPathExists=!/opt/bin/docker-compose

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStart=/usr/bin/mkdir -p /opt/bin
        ExecStart=/usr/bin/curl -fSsL https://github.com/docker/compose/releases/download/1.24.0/docker-compose-Linux-x86_64 -o /opt/bin/docker-compose
        ExecStart=/usr/bin/chmod +x /opt/bin/docker-compose
    - name: prometheus-westnetz-fetch.service
      contents: |
        [Unit]
        Description=Clone prometheus-westnetz repository
        After=gnupg-deployment-key.service
        Requires=gnupg-deployment-key.service
        ConditionPathExists=!/srv/prometheus-westnetz

        [Service]
        Type=oneshot
        RemainAfterExit=yes
        ExecStartPre=/usr/bin/mkdir -p /srv
        ExecStart=/bin/git clone https://github.com/westnetz/prometheus-westnetz.git /srv/prometheus-westnetz
        ExecStart=/srv/prometheus-westnetz/git-crypt/install.sh
        ExecStart=/usr/bin/bash -c 'cd /srv/prometheus-westnetz && /opt/bin/git-crypt unlock'
    - name: prometheus-westnetz.service
      contents: |
        [Unit]
        Description=Docker compose setup for Prometheus with Grafana
        After=docker-compose.service
        After=prometheus-westnetz-fetch.service
        Requires=docker-compose.service
        Requires=prometheus-westnetz-fetch.service

        [Service]
        EnvironmentFile=/srv/prometheus-westnetz/.env
        WorkingDirectory=/srv/prometheus-westnetz
        ExecStart=/srv/prometheus-westnetz/up.sh
        ExecStop=/opt/bin/docker-compose down

        [Install]
        WantedBy=multi-user.target
      enabled: yes
storage:
  directories:
    - filesystem: root
      path: /root
      mode: 0755
  files:
    - filesystem: root
      path: /root/deployment-key.pgp
      mode: 0600
      contents:
        local: deployment-key.pgp
